package com.sysmetrics.tests

import androidx.test.ext.junit.rules.ActivityTestRule
import androidx.test.ext.junit.runners.AndroidJUnit4
import androidx.test.rule.GrantPermissionRule
import com.kaspersky.components.kaspresso.testcases.api.testcase.TestCase
import com.sysmetrics.app.ui.MainActivityOverlay
import com.sysmetrics.screens.MainScreen
import com.sysmetrics.steps.MainScreenSteps.startOverlay
import com.sysmetrics.steps.MainScreenSteps.stopOverlay
import org.junit.Rule
import org.junit.Test
import org.junit.runner.RunWith

/**
 * Stability and stress tests for SysMetrics application
 * Tests long-running scenarios and resource management
 */
@RunWith(AndroidJUnit4::class)
class StabilityTest : TestCase() {

    @get:Rule(order = 0)
    val permissionRule: GrantPermissionRule = GrantPermissionRule.grant(
        android.Manifest.permission.WRITE_EXTERNAL_STORAGE,
        android.Manifest.permission.READ_EXTERNAL_STORAGE
    )

    @get:Rule(order = 1)
    val activityRule = ActivityTestRule(MainActivityOverlay::class.java, true, false)

    companion object {
        private const val STABILITY_TEST_DURATION_MS = 60000L // 1 minute
        private const val ITERATION_COUNT = 10
    }

    @Test
    fun overlayToggleStabilityTest() = run {
        before {
            activityRule.launchActivity(null)
        }.after {
            // Ensure overlay is stopped
            try {
                if (MainScreen.isVisible()) {
                    flakySafely(timeout = 3000) {
                        stopOverlay()
                    }
                }
            } catch (e: Exception) {
                // Ignore cleanup errors
            }
        }.run {

            step("Perform multiple start/stop cycles") {
                repeat(ITERATION_COUNT) { iteration ->
                    step("Cycle ${iteration + 1}/$ITERATION_COUNT") {
                        // Start overlay
                        startOverlay()

                        // Wait briefly
                        flakySafely(timeout = 2000) {
                            MainScreen.verifyMetricsPreviewVisible()
                        }

                        // Stop overlay
                        stopOverlay()

                        // Verify stopped state
                        MainScreen.verifyOverlayStatusOff()
                    }
                }
            }

            step("Verify app remains stable after multiple cycles") {
                MainScreen {
                    appTitle.isVisible()
                    toggleButton.isEnabled()
                    settingsButton.isEnabled()
                }
            }
        }
    }

    @Test
    fun metricsUpdateStabilityTest() = run {
        before {
            activityRule.launchActivity(null)
        }.after {
            // Stop overlay
            try {
                if (MainScreen.isVisible()) {
                    stopOverlay()
                }
            } catch (e: Exception) {
                // Ignore
            }
        }.run {

            step("Start overlay for stability test") {
                startOverlay()
            }

            step("Monitor metrics updates over extended period") {
                val startTime = System.currentTimeMillis()
                var updateCount = 0
                var lastCpuValue = ""

                while (System.currentTimeMillis() - startTime < STABILITY_TEST_DURATION_MS) {
                    flakySafely(timeout = 5000) {
                        MainScreen.cpuPreview {
                            val currentValue = getText().toString()
                            if (currentValue != lastCpuValue && currentValue.isNotEmpty()) {
                                updateCount++
                                lastCpuValue = currentValue
                            }
                            // Verify value format (should contain %)
                            assert(currentValue.contains("%")) {
                                "CPU value should contain percentage: $currentValue"
                            }
                        }
                    }

                    // Small delay between checks
                    Thread.sleep(1000)
                }

                // Should have received multiple updates
                assert(updateCount > 5) {
                    "Metrics should update multiple times during stability test. Got $updateCount updates"
                }
            }

            step("Stop overlay") {
                stopOverlay()
            }
        }
    }

    @Test
    fun memoryStabilityTest() = run {
        before {
            activityRule.launchActivity(null)
        }.after {
            // Cleanup
            try {
                if (MainScreen.isVisible()) {
                    stopOverlay()
                }
            } catch (e: Exception) {
                // Ignore
            }
        }.run {

            step("Start overlay") {
                startOverlay()
            }

            step("Verify RAM metrics are displayed correctly") {
                flakySafely(timeout = 5000) {
                    MainScreen.ramPreview {
                        isVisible()
                        val ramText = getText().toString()
                        // Format should be: "used / total MB"
                        assert(ramText.contains("/")) {
                            "RAM value should contain / separator: $ramText"
                        }
                        assert(ramText.contains("MB")) {
                            "RAM value should contain MB: $ramText"
                        }
                    }
                }
            }

            step("Verify temperature metrics are stable") {
                flakySafely(timeout = 5000) {
                    MainScreen.tempPreview {
                        isVisible()
                        val tempText = getText().toString()
                        // Should be either a temperature with °C or N/A
                        assert(tempText.contains("°C") || tempText == "N/A") {
                            "Temperature should be in °C or N/A: $tempText"
                        }
                    }
                }
            }

            step("Verify network metrics are stable") {
                flakySafely(timeout = 5000) {
                    MainScreen.networkPreview {
                        isVisible()
                        val networkText = getText().toString()
                        // Format should contain arrows
                        assert(networkText.contains("↓") || networkText.contains("↑")) {
                            "Network value should contain direction arrows: $networkText"
                        }
                    }
                }
            }

            step("Stop overlay") {
                stopOverlay()
            }
        }
    }

    @Test
    fun applicationStateConsistencyTest() = run {
        before {
            activityRule.launchActivity(null)
        }.after {
            // Cleanup
            try {
                if (MainScreen.isVisible()) {
                    stopOverlay()
                }
            } catch (e: Exception) {
                // Ignore
            }
        }.run {

            step("Verify initial state") {
                MainScreen.verifyOverlayStatusOff()
            }

            step("Start and stop overlay multiple times, verify state consistency") {
                repeat(5) { i ->
                    step("Iteration ${i + 1}") {
                        // Start
                        startOverlay()
                        MainScreen.verifyOverlayStatusOn()
                        MainScreen.verifyMetricsPreviewVisible()

                        // Stop
                        stopOverlay()
                        MainScreen.verifyOverlayStatusOff()
                        MainScreen.verifyMetricsPreviewHidden()
                    }
                }
            }

            step("Verify UI elements remain consistent") {
                MainScreen {
                    appTitle.isVisible()
                    statusText.isVisible()
                    toggleButton {
                        isVisible()
                        isEnabled()
                    }
                    settingsButton {
                        isVisible()
                        isEnabled()
                    }
                    permissionInfo.isVisible()
                }
            }
        }
    }
}
